<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="introduction_to_neo4j">




  <meta name="keywords" content="neo4j, spatial, geo, Anthon">










  <link rel="alternate" href="/default" title="Anthon">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1">



<link rel="canonical" href="http://code-monkey.top/2017/01/23/introduction-to-neo4j/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1">



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "MMvtgrWtn9BuiNVh6B529AP5-gzGzoHsz",
      appKey: "bA46NPkYiSG0QaBP2vX2ckzl"
    });
  </script>





<script>
  window.config = {"leancloud":{"app_id":"MMvtgrWtn9BuiNVh6B529AP5-gzGzoHsz","app_key":"bA46NPkYiSG0QaBP2vX2ckzl"},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> introduction_to_neo4j - Anthon </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">Anthon</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Anthon</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          introduction_to_neo4j
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-01-23
        </span>
        
        
        <span class="post-visits" data-url="/2017/01/23/introduction-to-neo4j/" data-title="introduction_to_neo4j">
          阅读次数 0
        </span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Git-安装"><span class="toc-text">Git 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven-安装"><span class="toc-text">Maven 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Neo4j-安装"><span class="toc-text">Neo4j 安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Neo4j-基本概念"><span class="toc-text">Neo4j 基本概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Neo4j-Cypher-基本操作"><span class="toc-text">Neo4j Cypher 基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Node语法"><span class="toc-text">Node语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关系语法"><span class="toc-text">关系语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模式语法"><span class="toc-text">模式语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模式变量"><span class="toc-text">模式变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条件"><span class="toc-text">条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建节点"><span class="toc-text">创建节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建关联"><span class="toc-text">创建关联</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建多个节点和关系"><span class="toc-text">创建多个节点和关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查找案例一"><span class="toc-text">查找案例一</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查询所有节点"><span class="toc-text">查询所有节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询某个节点"><span class="toc-text">查询某个节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#统计节点个数"><span class="toc-text">统计节点个数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询任意关系"><span class="toc-text">查询任意关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#按照属性值排序"><span class="toc-text">按照属性值排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询属性name的值是方兴东的节点，及其所有关联节点"><span class="toc-text">查询属性name的值是方兴东的节点，及其所有关联节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询属性name值是Kaine的节点，及其所有距离为1到3的关联节点"><span class="toc-text">查询属性name值是Kaine的节点，及其所有距离为1到3的关联节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询属性name的值是方兴东的节点，及其所有距离为2并且去除距离为1的节点"><span class="toc-text">查询属性name的值是方兴东的节点，及其所有距离为2并且去除距离为1的节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询方兴东和开心战士的共同粉丝"><span class="toc-text">查询方兴东和开心战士的共同粉丝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询-方兴东-到-庄北-的最短路径"><span class="toc-text">查询 方兴东 到 庄北 的最短路径</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查找案例二"><span class="toc-text">查找案例二</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查询张三的直接朋友"><span class="toc-text">查询张三的直接朋友</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询张三的朋友的朋友"><span class="toc-text">查询张三的朋友的朋友</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询张三所有的的朋友，包括朋友的朋友"><span class="toc-text">查询张三所有的的朋友，包括朋友的朋友</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询张三到吴十的最短路径"><span class="toc-text">查询张三到吴十的最短路径</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#索引"><span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#清空"><span class="toc-text">清空</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Neo4j-Spatial-简介"><span class="toc-text">Neo4j Spatial 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Neo4j-Spatial概念"><span class="toc-text">Neo4j Spatial概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Neo4j-Spatial特性"><span class="toc-text">Neo4j Spatial特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Neo4j-Spatial-空间数据读取"><span class="toc-text">Neo4j Spatial 空间数据读取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#地理图层与编码"><span class="toc-text">地理图层与编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#导入shapefile"><span class="toc-text">导入shapefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#导入OSM"><span class="toc-text">导入OSM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Neo4j-Server安装与配置"><span class="toc-text">Neo4j Server安装与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Neo4j-Server-安装"><span class="toc-text">Neo4j Server 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Neo4j-Server-配置参数"><span class="toc-text">Neo4j Server 配置参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Neo4j-Server与Spatial集成"><span class="toc-text">Neo4j Server与Spatial集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Neo4j-Server的spatial插件安装"><span class="toc-text">Neo4j Server的spatial插件安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Neo4j-Server的空间操作"><span class="toc-text">Neo4j Server的空间操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#索引新建"><span class="toc-text">索引新建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RTree关系可视化"><span class="toc-text">RTree关系可视化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#关于withinDistance查询结果排序问题"><span class="toc-text">关于withinDistance查询结果排序问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#neo4j-spatial-query-示例"><span class="toc-text">neo4j spatial query 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#withinDistance缓存区查询"><span class="toc-text">withinDistance缓存区查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#bbox矩形查询"><span class="toc-text">bbox矩形查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#withinWKTGeometry查询"><span class="toc-text">withinWKTGeometry查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#空间索引和关系遍历联合查询"><span class="toc-text">空间索引和关系遍历联合查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#与GeoServer集成"><span class="toc-text">与GeoServer集成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-text">问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#建空间索引内存溢出问题"><span class="toc-text">建空间索引内存溢出问题</span></a></li></ol></li></ol></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>“Neo4j是一个高性能的，非关系的，具有完全事务特性的,鲁棒的图数据库。” neo4j在处理复杂的网络数据时候，具有很好的性能表现[1]，适用于社交网络，动态网络等场景。它基于java语言实现，有两个分发版本，社区版(community version)以GPLv3的许可在Github上开源，源码地址:<a href="https://github.com/neo4j/community；企业版，同时遵循AGPLv3和商业许可，它在社区版基础上增加了包括高可用性(High" target="_blank" rel="noopener">https://github.com/neo4j/community；企业版，同时遵循AGPLv3和商业许可，它在社区版基础上增加了包括高可用性(High</a> Availability)，全天侯支持等特性。Neo4j的开发非常活跃，围绕它有非常多的项目，包括 REST API 绑定（各种语言实现列表），空间数据库支持（源码地址）等。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="Git-安装"><a href="#Git-安装" class="headerlink" title="Git 安装"></a>Git 安装</h2><p>Git的安装非常简单，大多数的Linux发行版本的源中都打包好。以Ubuntu 为例(仅测试Oneiric，Precise)，只需要输入如下命令即可安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  apt-get install git</span><br></pre></td></tr></table></figure>
<h2 id="Maven-安装"><a href="#Maven-安装" class="headerlink" title="Maven 安装"></a>Maven 安装</h2><p>同样的Ubuntu（我最爱系统）下，安装Maven3非常简单，输入如下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get maven</span><br></pre></td></tr></table></figure>
<h2 id="Neo4j-安装"><a href="#Neo4j-安装" class="headerlink" title="Neo4j 安装"></a>Neo4j 安装</h2><p>安装好以上两者后，我们直接从github的源码，并用maven来安装neo4j，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir neo4j</span><br><span class="line"><span class="built_in">cd</span> ./neo4j</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/neo4j/community.git</span><br><span class="line">mvn clean install</span><br></pre></td></tr></table></figure>
<p>如此，neo4j即安装成功。如果需要build不同的版本可以遵照参考文献5Readme的指示来实现。</p>
<a id="more"></a>
<h1 id="Neo4j-基本概念"><a href="#Neo4j-基本概念" class="headerlink" title="Neo4j 基本概念"></a>Neo4j 基本概念</h1><p>Neo4j中不存在表的概念，只有两类：节点( Node )和关联( Relation )，可以简单理解为图里面的点和边。 在数据查询中，节点一般用小括号()，关联用中括号[]。 当然也隐含路径的概念，是用节点和关联表示的，如：(a)-[r]-&gt;(b)，表示一条从节点a经关联r到节点b的路径。</p>
<ul>
<li>节点： 图中的对象 可带若干名-值属性 可带标签 例： (m:Movie {title:”The Matrix”})</li>
<li>关系： 连接节点（有类型、带方向） 可带若干名-值属性 例：(a)-[:ACTED_IN {roles:[“Neo”]}]-&gt;(m)</li>
</ul>
<h1 id="Neo4j-Cypher-基本操作"><a href="#Neo4j-Cypher-基本操作" class="headerlink" title="Neo4j Cypher 基本操作"></a>Neo4j Cypher 基本操作</h1><p>cypher是neo4j官网提供的声明式查询语言，非常强大，用它可以完成任意的图谱里面的查询过滤，我们知识图谱的一期项目 基本开发完毕，后面会陆续总结学习一下neo4j相关的知识。今天接着上篇文章来看下neo4j的cpyher查询的一些基本概念和语法。</p>
<h2 id="Node语法"><a href="#Node语法" class="headerlink" title="Node语法"></a>Node语法</h2><p>在cypher里面通过用一对小括号()表示一个节点，它在cypher里面查询形式如下：</p>
<ol>
<li>() 代表匹配任意一个节点</li>
<li>(node1) 代表匹配任意一个节点，并给它起了一个别名</li>
<li>(:Lable) 代表查询一个类型的数据</li>
<li>(person:Lable) 代表查询一个类型的数据，并给它起了一个别名</li>
<li>(person:Lable {name:”小王”}) 查询某个类型下，节点属性满足某个值的数据</li>
<li>(person:Lable {name:”小王”,age:23}) 节点的属性可以同时存在多个，是一个AND的关系</li>
</ol>
<h2 id="关系语法"><a href="#关系语法" class="headerlink" title="关系语法"></a>关系语法</h2><p>关系用一对-组成，关系分有方向的进和出，如果是无方向就是进和出都查询</p>
<ol>
<li>-&gt; 指向一个节点</li>
<li>-[role]-&gt; 给关系加个别名</li>
<li>-[:acted_in]-&gt; 访问某一类关系</li>
<li>-[role:acted_in]-&gt; 访问某一类关系，并加了别名</li>
<li>-[role:acted_in {roles:[“neo”,”hadoop”]}]-&gt; 访问某一类关系下的某个属性的关系的数据</li>
</ol>
<h2 id="模式语法"><a href="#模式语法" class="headerlink" title="模式语法"></a>模式语法</h2><p>模式语法是节点和关系查询语法的结合，通过模式语法我们可以进行我们想要的任意复杂的查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(p1: Person:Actor &#123;name:”tom”&#125;)-[role:acted_in &#123;roles:[“neo”,”actor”]&#125;]-(m1:Movie &#123;title:”water”&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="模式变量"><a href="#模式变量" class="headerlink" title="模式变量"></a>模式变量</h2><p>为了增加模块化和减少重复，cypher允许把模式的结果指定在一个变量或者别名中，方便后续使用或操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path = (: Person)-[:ACTED_IN]-&gt;(:Movie)</span><br></pre></td></tr></table></figure>
<ul>
<li>path是结果集的抽象封装，有多个函数可以直接从path里面提取数据如：</li>
<li>nodes(path)：提取所有的节点</li>
<li>rels(path): 提取所有的关系 和relationships(path)相等</li>
<li>length(path): 获取路径长度</li>
</ul>
<h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><p>cypher语句也是由多个关键词组成，像SQL的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select name, count() from talbe where age=24 group by name having count() &gt;2 order by count(*) desc</span><br></pre></td></tr></table></figure>
<p>多个关键字组成的语法，cypher也非常类似，每个关键词会执行一个特定的task来处理数据 match: 查询的主要关键词 create: 类似sql里面的insert filter，project，sort，page等都有对应的功能语句 通过组合上面的一些语句，我们可以写出非常强大复杂的语法，来查询我们想要检索的内容，cypher会 自动解析语法并优化执行。</p>
<h2 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h2><p>CREATE (节点名:标签 {属性key1:属性value1,属性key2:属性value2,……})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE (p1:Person &#123; name: &quot;entere&quot;, age: 30, pid: 1 &#125;)</span><br><span class="line">CREATE (p2:Person &#123; name: &quot;fxd&quot;, age: 40, pid: 2 &#125;)</span><br></pre></td></tr></table></figure>
<p>CREATE 创建数据</p>
<ul>
<li>() 表示节点 p1:Person，p1 是节点名( node )，Person 是 节点的标签名( lable )</li>
<li>{} 是节点属性</li>
</ul>
<p>要记住的事情: Neo4j的数据库服务器使用该&lt;节点名称&gt;以存储Database.As一个Neo4j的DBA或开发该节点的详细信息，我们不能用它来访问节点的详细信息。</p>
<p>Neo4j的数据库服务器创建一个&lt;标签名称&gt;作为别名到内部节点name.As一个Neo4j的DBA或开发人员，我们应该利用这个标签名称访问节点的详细信息。</p>
<h2 id="创建关联"><a href="#创建关联" class="headerlink" title="创建关联"></a>创建关联</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match (p1),(p2)</span><br><span class="line">where p1.pid=1 and p2.pid=2</span><br><span class="line">create (p1)-[:HAS_FANS]-&gt;(p2)</span><br></pre></td></tr></table></figure>
<p>创建 p1 节点和 p2 节点的路径，此时变量 HAS_FANS 即代表关联，它也可以有标签 注意：创建关联之前须先创建节点，如果先创建关联，在创建节点会出问题</p>
<h2 id="创建多个节点和关系"><a href="#创建多个节点和关系" class="headerlink" title="创建多个节点和关系"></a>创建多个节点和关系</h2><p>CREATE (节点1), (节点2), (节点3), (节点4), (节点1)-[关系1]-&gt;(节点2), (节点2)-[关系2]-&gt;(节点3),</p>
<h1 id="查找案例一"><a href="#查找案例一" class="headerlink" title="查找案例一"></a>查找案例一</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CREATE</span><br><span class="line">(p1:Person &#123;name: &quot;方兴东&quot;,uid:1&#125;),</span><br><span class="line">(p2:Person &#123;name: &quot;甜夏&quot;,uid:2&#125;),</span><br><span class="line">(p3:Person &#123;name: &quot;开心战士&quot;,uid:3&#125;),</span><br><span class="line">(p4:Person &#123;name: &quot;狐狸猫&quot;,uid:4&#125;),</span><br><span class="line">(p5:Person &#123;name: &quot;唐镇宇&quot;,uid:5&#125;),</span><br><span class="line">(p6:Person &#123;name: &quot;郭思思&quot;,uid:6&#125;),</span><br><span class="line">(p7:Person &#123;name: &quot;庄北&quot;,uid:7&#125;),</span><br><span class="line">(p1)-[:HAS_FANS]-&gt;(p2),</span><br><span class="line">(p1)-[:HAS_FANS]-&gt;(p3),</span><br><span class="line">(p1)-[:HAS_FANS]-&gt;(p4),</span><br><span class="line">(p1)-[:HAS_FANS]-&gt;(p5),</span><br><span class="line">(p1)-[:HAS_FANS]-&gt;(p6),</span><br><span class="line">(p2)-[:HAS_FANS]-&gt;(p3),</span><br><span class="line">(p2)-[:HAS_FANS]-&gt;(p4),</span><br><span class="line">(p2)-[:HAS_FANS]-&gt;(p1),</span><br><span class="line">(p4)-[:HAS_FANS]-&gt;(p3),</span><br><span class="line">(p3)-[:HAS_FANS]-&gt;(p4),</span><br><span class="line">(p3)-[:HAS_FANS]-&gt;(p7);</span><br><span class="line"></span><br><span class="line">MATCH (p:Person) RETURN p</span><br></pre></td></tr></table></figure>
<h2 id="查询所有节点"><a href="#查询所有节点" class="headerlink" title="查询所有节点"></a>查询所有节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match (n) return n</span><br></pre></td></tr></table></figure>
<h2 id="查询某个节点"><a href="#查询某个节点" class="headerlink" title="查询某个节点"></a>查询某个节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (a:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(b) return a,b</span><br><span class="line">match p = (a:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(b) return p;</span><br><span class="line">match p = (a:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(b) return nodes(p);</span><br><span class="line">match p = (a:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(b) return rels(p)</span><br></pre></td></tr></table></figure>
<h2 id="统计节点个数"><a href="#统计节点个数" class="headerlink" title="统计节点个数"></a>统计节点个数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match (a:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(b) return count(b)</span><br></pre></td></tr></table></figure>
<h2 id="查询任意关系"><a href="#查询任意关系" class="headerlink" title="查询任意关系"></a>查询任意关系</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match (a:Person &#123;name:”方兴东”&#125;)-[*]-&gt;(b) return a,b</span><br></pre></td></tr></table></figure>
<h2 id="按照属性值排序"><a href="#按照属性值排序" class="headerlink" title="按照属性值排序"></a>按照属性值排序</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match (a:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(b) return a,b order by b.uid desc</span><br></pre></td></tr></table></figure>
<h2 id="查询属性name的值是方兴东的节点，及其所有关联节点"><a href="#查询属性name的值是方兴东的节点，及其所有关联节点" class="headerlink" title="查询属性name的值是方兴东的节点，及其所有关联节点"></a>查询属性name的值是方兴东的节点，及其所有关联节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">match (a)-[r]-&gt;(b) where a.name=’方兴东’ return a,b</span><br><span class="line">match (a &#123;name:’方兴东’&#125;)-[r]-&gt;(b) return a,b</span><br></pre></td></tr></table></figure>
<h2 id="查询属性name值是Kaine的节点，及其所有距离为1到3的关联节点"><a href="#查询属性name值是Kaine的节点，及其所有距离为1到3的关联节点" class="headerlink" title="查询属性name值是Kaine的节点，及其所有距离为1到3的关联节点"></a>查询属性name值是Kaine的节点，及其所有距离为1到3的关联节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">match (a)-[1..3]-&gt;(b) where a.name=’方兴东’ return a,b</span><br><span class="line">match (a &#123;name:’方兴东’&#125;)-[1..3]-&gt;(b) return a,b</span><br></pre></td></tr></table></figure>
<h2 id="查询属性name的值是方兴东的节点，及其所有距离为2并且去除距离为1的节点"><a href="#查询属性name的值是方兴东的节点，及其所有距离为2并且去除距离为1的节点" class="headerlink" title="查询属性name的值是方兴东的节点，及其所有距离为2并且去除距离为1的节点"></a>查询属性name的值是方兴东的节点，及其所有距离为2并且去除距离为1的节点</h2><p>在计算好友的好友时会用到，即如果a、b、c三个人都认识，如果仅计算跟a距离为2的人的时候会把b、c也算上，因为a-&gt;b-&gt;c，或者a-&gt;c-&gt;b都是通路）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match (a)-[2]-&gt;(b) where a.name=’方兴东’ and not (a)-[1]-&gt;(b) return a,b</span><br></pre></td></tr></table></figure>
<h2 id="查询方兴东和开心战士的共同粉丝"><a href="#查询方兴东和开心战士的共同粉丝" class="headerlink" title="查询方兴东和开心战士的共同粉丝"></a>查询方兴东和开心战士的共同粉丝</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p1:Person &#123;name:”方兴东”&#125;)-[:HAS_FANS]-&gt;(x)&lt;-[:HAS_FANS]-(p2:Person &#123;name:”开心战士”&#125;) return x;</span><br></pre></td></tr></table></figure>
<p>注：关联的中括号内数字的含义</p>
<ul>
<li>n 距离为n</li>
<li>..n 最大距离为n</li>
<li>n.. 最小距离为n</li>
<li>m..n 距离在m到n之间</li>
</ul>
<h2 id="查询-方兴东-到-庄北-的最短路径"><a href="#查询-方兴东-到-庄北-的最短路径" class="headerlink" title="查询 方兴东 到 庄北 的最短路径"></a>查询 方兴东 到 庄北 的最短路径</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match p = shortestPath( (p1:Person &#123;name:”方兴东”&#125;)-[:HAS_FRIEND*..3]-&gt;(p2:Person &#123;name:”庄北”&#125;) ) return p;</span><br></pre></td></tr></table></figure>
<h1 id="查找案例二"><a href="#查找案例二" class="headerlink" title="查找案例二"></a>查找案例二</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">create</span><br><span class="line">(p3:User &#123;name:&quot;张三&quot;&#125;),</span><br><span class="line">(p4:User &#123;name:&quot;李四&quot;&#125;),</span><br><span class="line">(p5:User &#123;name:&quot;王五&quot;&#125;),</span><br><span class="line">(p6:User &#123;name:&quot;赵六&quot;&#125;),</span><br><span class="line">(p7:User &#123;name:&quot;钱七&quot;&#125;),</span><br><span class="line">(p8:User &#123;name:&quot;孙八&quot;&#125;),</span><br><span class="line">(p9:User &#123;name:&quot;杨九&quot;&#125;),</span><br><span class="line">(p10:User &#123;name:&quot;吴十&quot;&#125;),</span><br><span class="line">(p3)-[:HAS_FRIEND]-&gt;(p4),</span><br><span class="line">(p3)-[:HAS_FRIEND]-&gt;(p5),</span><br><span class="line">(p4)-[:HAS_FRIEND]-&gt;(p6),</span><br><span class="line">(p4)-[:HAS_FRIEND]-&gt;(p7),</span><br><span class="line">(p5)-[:HAS_FRIEND]-&gt;(p8),</span><br><span class="line">(p5)-[:HAS_FRIEND]-&gt;(p9),</span><br><span class="line">(p6)-[:HAS_FRIEND]-&gt;(p10);</span><br></pre></td></tr></table></figure>
<h2 id="查询张三的直接朋友"><a href="#查询张三的直接朋友" class="headerlink" title="查询张三的直接朋友"></a>查询张三的直接朋友</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p:User &#123;name : “张三”&#125;)-[:HAS_FRIEND]-&gt;(f) return p,f;</span><br></pre></td></tr></table></figure>
<h2 id="查询张三的朋友的朋友"><a href="#查询张三的朋友的朋友" class="headerlink" title="查询张三的朋友的朋友"></a>查询张三的朋友的朋友</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p:User &#123;name : “张三”&#125;)-[:HAS_FRIEND]-&gt;()-[:HAS_FRIEND]-&gt;(f) return p,f;</span><br></pre></td></tr></table></figure>
<h2 id="查询张三所有的的朋友，包括朋友的朋友"><a href="#查询张三所有的的朋友，包括朋友的朋友" class="headerlink" title="查询张三所有的的朋友，包括朋友的朋友"></a>查询张三所有的的朋友，包括朋友的朋友</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p:User &#123;name : “张三”&#125;)-[*]-&gt;(f) return p,f;</span><br></pre></td></tr></table></figure>
<h2 id="查询张三到吴十的最短路径"><a href="#查询张三到吴十的最短路径" class="headerlink" title="查询张三到吴十的最短路径"></a>查询张三到吴十的最短路径</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match p = shortestPath( (p3:User &#123;name:”张三”&#125;)-[:HAS_FRIEND*..15]-&gt;(p10:User &#123;name:”吴十”&#125;) ) return p;</span><br></pre></td></tr></table></figure>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">:schema 列出所有标签的所有记录</span><br><span class="line">:schema ls -l :YourLabel 列出指定标签的索引与约束</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE CONSTRAINT ON (p:Person) ASSERT p.name IS UNIQUE //唯一约束</span><br><span class="line">CREATE INDEX ON :Person(name);  //创建索引</span><br></pre></td></tr></table></figure>
<h2 id="清空"><a href="#清空" class="headerlink" title="清空"></a>清空</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match(n)</span><br><span class="line">optional match(n)-[r]-()</span><br><span class="line">delete n,r</span><br></pre></td></tr></table></figure>
<h1 id="Neo4j-Spatial-简介"><a href="#Neo4j-Spatial-简介" class="headerlink" title="Neo4j Spatial 简介"></a>Neo4j Spatial 简介</h1><h2 id="Neo4j-Spatial概念"><a href="#Neo4j-Spatial概念" class="headerlink" title="Neo4j Spatial概念"></a>Neo4j Spatial概念</h2><p>Neo4j Spatial项目是图数据库Neo4j的一个插件，它通过将空间数据映射到图模型(graph model)，它将对象和关系当作顶点和边存储在图模型中。因而使得Neo4j具有空间数据的导入，存储，查询等功能。Neo4j Spatial支持的地理要素遵循OpenGIS的规范，包括点(point),线段(line-string),面(polygon),多点(multipoint),多线段(multi-linestring)等简单要素。Neo4j Spatial使用R树作为空间索引，主要是集成了Lucene 的索引库，支持的空间查询包括覆盖(cover),被覆盖（cover by),包含（contian),相交(intersect)等。一般而言，R树会将叶子结点（COUNT,LEVEL,</p>
<p><oii,mbri>）上几何要素分组并用它们的数据矩形来表示，相比PostGIS所使用的优化过GisT[13]索引要低效，会使Neo4j在范围查询上效率有所不及PostGIS，但它对适合图模型的数据（如网络数据）操作效率非常高。综上所述，Neo4j在符合图数据模型的分析中如邻近搜索，路径分析等这些特定类型的应用有非常大的优势。&lt;/oii,mbri&gt;</oii,mbri></p>
<h2 id="Neo4j-Spatial特性"><a href="#Neo4j-Spatial特性" class="headerlink" title="Neo4j Spatial特性"></a>Neo4j Spatial特性</h2><p>Neo4j Spatial的部分核心特性包括</p>
<ul>
<li>支持Esri Shapefile格式，OSM(OpenStreetMap)格式（只支持.osm格式）（补充：Open Street Map目前逐步适用PBF替代OSM）</li>
<li>支持所有通用的几何要素</li>
<li>在空间查询的时候支持拓扑操作</li>
<li>允许任何图数据都实现空间操作功能</li>
<li>能够将单一图层或者数据集拆分成多个子图层</li>
</ul>
<h2 id="Neo4j-Spatial-空间数据读取"><a href="#Neo4j-Spatial-空间数据读取" class="headerlink" title="Neo4j Spatial 空间数据读取"></a>Neo4j Spatial 空间数据读取</h2><h3 id="地理图层与编码"><a href="#地理图层与编码" class="headerlink" title="地理图层与编码"></a>地理图层与编码</h3><p>Spatial 库中首先需要定义图层中几何要素，可供查询的索引，同时图层是否可编辑 ，其次是确定几何编码接口。Spatial类库提供的默认图层是标准图层，使用WKBGeometryEncoder，将所有的要素以字节数组的形式来存储。地理数据中实体的属性会当作图数据模型中顶点的属性来存储。OSMLayer 是支持Open Street Map格式的特殊图层，neo4j使用单个完全图来存储该图层。同时 OMSLayer继承动态图层，允许包含任意个子图层。</p>
<h3 id="导入shapefile"><a href="#导入shapefile" class="headerlink" title="导入shapefile"></a>导入shapefile</h3><p>导入shapefile大概过程是1.生存Neo4j数据库（调用已有） 2.实例化，并调用ShapefileImporter 3.关闭数据库 实例代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> edu.sirc.gis.data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.geotools.data.shapefile.shp.ShapefileException;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.gis.spatial.Layer;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.gis.spatial.ShapefileImporter;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.gis.spatial.SpatialDatabaseService;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.graphdb.GraphDatabaseService;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.kernel.EmbeddedGraphDatabase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">importShapefiletest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * import shapefile to neo4j database</span></span><br><span class="line"><span class="comment">     * just Extract from the org.neo4j.gis.spatial.testfordoc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String databasepath=<span class="string">"/home/vent/environment/neo4j/gis"</span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">importShapfile</span><span class="params">()</span> <span class="keyword">throws</span> ShapefileException, FileNotFoundException, IOException</span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         System.out.println(<span class="string">"\n=== Test Import Shapefile ==="</span>);</span><br><span class="line"></span><br><span class="line">         GraphDatabaseService graphdb = <span class="keyword">new</span> EmbeddedGraphDatabase(databasepath);</span><br><span class="line">         <span class="keyword">try</span></span><br><span class="line">         &#123;</span><br><span class="line">             ShapefileImporter shpImporter = <span class="keyword">new</span> ShapefileImporter(graphdb);</span><br><span class="line">             shpImporter.importFile(<span class="string">"/home/vent/environment/neo4j/data/shp/river.shp"</span>, <span class="string">"river"</span>, Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">finally</span></span><br><span class="line">         &#123;</span><br><span class="line">             graphdb.shutdown();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ShapefileException, FileNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        importShapefiletest isf = <span class="keyword">new</span> importShapefiletest();</span><br><span class="line">        isf.importShapfile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="导入OSM"><a href="#导入OSM" class="headerlink" title="导入OSM"></a>导入OSM</h3><p>导入OSM的过程和导入shapefile差异不大，旧版Neo4j Spatial 提供了批量读入的接口BatchInserter，可以加快大文件的导入。具体JavaDoc请参阅打包后的文档。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> edu.sirc.gis.data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.neo4j.gis.spatial.osm.OSMImporter;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.graphdb.GraphDatabaseService;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.kernel.EmbeddedGraphDatabase;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.kernel.impl.batchinsert.BatchInserter;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.kernel.impl.batchinsert.BatchInserterImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">importOSMTest</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//import osm file into the default db for server .</span></span><br><span class="line">    <span class="keyword">private</span> String databasepath=<span class="string">"/home/vent/environment/neo4j/data/graph.db"</span>;</span><br><span class="line">    <span class="keyword">private</span> String osmPath=<span class="string">"/home/vent/Downloads/"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; NORMAL_CONFIG = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        NORMAL_CONFIG.put( <span class="string">"neostore.nodestore.db.mapped_memory"</span>, <span class="string">"50M"</span> );</span><br><span class="line">        NORMAL_CONFIG.put( <span class="string">"neostore.relationshipstore.db.mapped_memory"</span>, <span class="string">"120M"</span> );</span><br><span class="line">        NORMAL_CONFIG.put( <span class="string">"neostore.propertystore.db.mapped_memory"</span>, <span class="string">"150M"</span> );</span><br><span class="line">        NORMAL_CONFIG.put( <span class="string">"neostore.propertystore.db.strings.mapped_memory"</span>, <span class="string">"200M"</span> );</span><br><span class="line">        NORMAL_CONFIG.put( <span class="string">"neostore.propertystore.db.arrays.mapped_memory"</span>, <span class="string">"0M"</span> );</span><br><span class="line">        NORMAL_CONFIG.put( <span class="string">"dump_configuration"</span>, <span class="string">"false"</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span>  <span class="title">importOSM</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        OSMImporter osmIm = <span class="keyword">new</span> OSMImporter(<span class="string">"FUJIAN"</span>);</span><br><span class="line">        Map&lt;String, String&gt; config = NORMAL_CONFIG;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">        <span class="comment">//BatchInserter baIns = new BatchInserterImpl(osmPath,config);</span></span><br><span class="line">        String dataset =<span class="string">"/home/vent/Downloads/Fujian.osm"</span>;</span><br><span class="line">        <span class="comment">//osmIm.importFile(baIns,dataset,false);</span></span><br><span class="line"></span><br><span class="line">        GraphDatabaseService db = <span class="keyword">new</span> EmbeddedGraphDatabase(databasepath);</span><br><span class="line">        osmIm.importFile(db, dataset);</span><br><span class="line">        osmIm.reIndex(db, <span class="number">100</span>);</span><br><span class="line">        db.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        importOSMTest iOSM = <span class="keyword">new</span> importOSMTest();</span><br><span class="line">        iOSM.importOSM();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Neo4j-Server安装与配置"><a href="#Neo4j-Server安装与配置" class="headerlink" title="Neo4j Server安装与配置"></a>Neo4j Server安装与配置</h2><h3 id="Neo4j-Server-安装"><a href="#Neo4j-Server-安装" class="headerlink" title="Neo4j Server 安装"></a>Neo4j Server 安装</h3><p>Neo4j可以安装成数据库服务器，能够已应用或者系统服务两种形式运行在操作系统中。它内置了jetty 和REST接口，来实现使用浏览器对数据库操作</p>
<ul>
<li>在neo4j官网<a href="http://neo4j.org/download下载你喜欢的版本(需要选择你的操作系统" target="_blank" rel="noopener">http://neo4j.org/download下载你喜欢的版本(需要选择你的操作系统</a>)</li>
<li>解压到特定位置，解压路径表述为$NEO4J_HOME(如/home/dev/neo4j/)</li>
<li><p>启动脚本在$NEO4J_HOME/bin 文件夹下,在Linux/MacOS下，运行 $NEO4J_HOME/bin/neo4j start 在Window 只要双击%NEO4J_HOME%\bin\Neo4j.bat文件即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd $NEO4J_HOME/bin/</span><br><span class="line">$NEO4J_HOME/bin/neo4j start</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>我们只需要访问 <a href="http://localhost:7474/webadmin/" target="_blank" rel="noopener">http://localhost:7474/webadmin/</a> 会出现Neo4j 的web 管理界面，如图1所示: <img src="/2017/01/23/introduction-to-neo4j/1.png"></p>
<p>在Web 管理界面，我们可以查看数据库的节点，属性，关系信息。还可以通过Http ，Shell 和Germlin三种方式来对图数据库做CRUD。如果需要将Neo4j Server 以系统服务的方式运行</p>
<h3 id="Neo4j-Server-配置参数"><a href="#Neo4j-Server-配置参数" class="headerlink" title="Neo4j Server 配置参数"></a>Neo4j Server 配置参数</h3><p>如果我们需要对服务器的后端数据库性能调优等，可以通过Server的配置文件来了解图数据库的具体参数。这些重要的参数都存储在$NEO4J_HOME/conf/neo4j-server.properties文件内，包括服务器数据库在磁盘上的路径：</p>
<p>org.neo4j.server.database.location=data/graph.db http 服务器接口:</p>
<p>org.neo4j.server.database.location=data/graph.db 设置REST数据接口所能够操纵的数据库的相对路径</p>
<p>org.neo4j.server.webadmin.data.uri=/db/data/ 等。</p>
<p>至于Neo4j的性能参数和日志参数分别参看$NEO4J_HOME/conf/neo4j.properties,$NEO4J_HOME/conf/logging.properties两个文件。</p>
<h2 id="Neo4j-Server与Spatial集成"><a href="#Neo4j-Server与Spatial集成" class="headerlink" title="Neo4j Server与Spatial集成"></a>Neo4j Server与Spatial集成</h2><h3 id="Neo4j-Server的spatial插件安装"><a href="#Neo4j-Server的spatial插件安装" class="headerlink" title="Neo4j Server的spatial插件安装"></a>Neo4j Server的spatial插件安装</h3><p>讲我们通过利用源码安装了neo4j spatial ,在/target目录下会有一个neo4j-spatial-0.9-SNAPSHOT-server-plugin.zip文件。如果没有，可以运行以下命令来获得该文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/neo4j/spatial.git</span><br><span class="line">cd ./spatial</span><br><span class="line">mvn clean package -DskipTests</span><br></pre></td></tr></table></figure>
<p>将该文件解压到，复制所有的jar包到neo4j 的lib文件夹内，然后重启neo4j server即可。</p>
<h3 id="Neo4j-Server的空间操作"><a href="#Neo4j-Server的空间操作" class="headerlink" title="Neo4j Server的空间操作"></a>Neo4j Server的空间操作</h3><h4 id="索引新建"><a href="#索引新建" class="headerlink" title="索引新建"></a>索引新建</h4><ul>
<li>Create a Spatial index</li>
<li>Create nodes with lat/lon data as properties</li>
<li>Add these nodes to the Spatial index</li>
</ul>
<h4 id="RTree关系可视化"><a href="#RTree关系可视化" class="headerlink" title="RTree关系可视化"></a>RTree关系可视化</h4><img src="/2017/01/23/introduction-to-neo4j/3.png">
<h4 id="关于withinDistance查询结果排序问题"><a href="#关于withinDistance查询结果排序问题" class="headerlink" title="关于withinDistance查询结果排序问题"></a>关于withinDistance查询结果排序问题</h4><ul>
<li><p>球面距离计算采用OrthodromicDistance算法：d = acos( sin(lat1)_sin(lat2) + cos(lat1)_cos(lat2)_cos(lon2-lon1) )_ R，Neo4j-Spatial中的实现：org.neo4j.gis.spatial.pipes.processing.OrthodromicDistance</p>
</li>
<li><p>返回结果默认以命中目标坐标与查询中心点坐标的距离进行排序 参考Neo4j Spatial 源码测试用例中的：TestSimplePointLayer中的checkPointOrder， 查询示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;geopipeflow&gt; res = GeoPipeline. startNearestNeighborLatLonSearch( layer, start, distance).sort(&quot;OrthodromicDistance&quot;).toList();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="neo4j-spatial-query-示例"><a href="#neo4j-spatial-query-示例" class="headerlink" title="neo4j spatial query 示例"></a>neo4j spatial query 示例</h4><h5 id="withinDistance缓存区查询"><a href="#withinDistance缓存区查询" class="headerlink" title="withinDistance缓存区查询"></a>withinDistance缓存区查询</h5><p>查询点120.678966,31.300864周边0.1km范围内的Node</p>
<p>格式：START n = node:<layer>(“withinDistance:[<y>, <x>, <max distance="" in="" km="">]”)</max></x></y></layer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start n = node:geom(&apos;withinDistance:[31.331937,120.638154,0.1]&apos;) return n limit 10</span><br></pre></td></tr></table></figure>
<h5 id="bbox矩形查询"><a href="#bbox矩形查询" class="headerlink" title="bbox矩形查询"></a>bbox矩形查询</h5><p>查询由点1(120.678966,31.300864)与点2(120.978966,31.330864)构成的BBox矩形范围内的Node</p>
<p>格式：START n = node:<layer>(“bbox:[<min x="">, <max x="">, <min y="">, <max y="">]”)</max></min></max></min></layer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start n = node:geom(&apos;bbox:[120.678966,120.978966,31.300864,31.330864]&apos;) return n limit 10</span><br></pre></td></tr></table></figure>
<h5 id="withinWKTGeometry查询"><a href="#withinWKTGeometry查询" class="headerlink" title="withinWKTGeometry查询"></a>withinWKTGeometry查询</h5><p>查询由点1(120.678966,31.300864)与点2(120.978966,31.330864)构成的Polygon多边形范围内的Node</p>
<p>格式：START n = node:<layer>(“withinWKTGeometry:POLYGON((<x1> <y1>, …, <xn> <yn>, <x1> <y1>))”)</y1></x1></yn></xn></y1></x1></layer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start n = node:geoindex(&apos;withinWKTGeometry:POLYGON ((120.678966 31.300864, 120.678966 31.330864, 120.978966 31.330864, 120.978966 31.300864, 120.678966 31.300864))&apos;)  return n limit 10</span><br></pre></td></tr></table></figure>
<h3 id="空间索引和关系遍历联合查询"><a href="#空间索引和关系遍历联合查询" class="headerlink" title="空间索引和关系遍历联合查询"></a>空间索引和关系遍历联合查询</h3><p>联合geom索引图层和match进行查询</p>
<ul>
<li>查询指定范围&amp;&amp;指定path路径中的节点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start n = node:geom(&apos;withinDistance:[31.331937,120.638154,0.1]&apos;)</span><br><span class="line">match path=(:DIS&#123;text:&apos;工业园区&apos;&#125;)-[:BELONGTO ]-(:POI&#123;text:&apos;拙政别墅&apos;&#125;)</span><br><span class="line">where n in nodes(path)</span><br><span class="line">return n,path</span><br></pre></td></tr></table></figure>
<p>优化后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">profile start n = node:geom(&apos;withinDistance:[31.331937,120.638154,0.1]&apos;)</span><br><span class="line">match path=(:DIS&#123;text:&apos;工业园区&apos;&#125;)&lt;-[:BELONGTO ]-(n)</span><br><span class="line">return path</span><br></pre></td></tr></table></figure>
<p>查询结果可视化效果图<br><img src="/2017/01/23/introduction-to-neo4j/4.png"></p>
<ul>
<li>联合查询：withinWKTGeometry空间过滤与match属性过滤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">profile start n = node:geoindex(&apos;withinWKTGeometry:POLYGON ((120.678966 31.300864, 120.678966 31.330864, 120.978966 31.330864, 120.978966 31.300864, 120.678966 31.300864))&apos;)</span><br><span class="line">match (n)</span><br><span class="line">where (n.ruleabbr in [&apos;POI&apos;,&apos;STR&apos;]) and n.spapriority=1</span><br><span class="line">and ANY(adtext IN n.adtext WHERE adtext =~ &apos;.*公司.*&apos; )</span><br><span class="line">return n limit 10</span><br></pre></td></tr></table></figure>
<ul>
<li>CypherQL必须先执行空间索引，再执行Relation过滤，这样每个空间围内的Node都要进行Relationship过滤，效率较低；</li>
<li>若能先执行Match再执行空间过滤，可提高SpatialIndex命中率</li>
<li>若无分页需求，可临时采用NativeAPI进行Match过滤，再以SpatialIndex withinDiatance过滤。</li>
<li>若需要分页的话skip limit必须在CypherQL中实现，但是空间索引与关系遍历并行的CQL怎么写？暂时无解！</li>
</ul>
<h2 id="与GeoServer集成"><a href="#与GeoServer集成" class="headerlink" title="与GeoServer集成"></a>与GeoServer集成</h2><p>GeoServer是一款基于java的开源的地图服务器，支持包括shapefile，postgis等多种数据源。neo4j spatial能够以插件的形式与GeoServer集成。集成方法如下：</p>
<ul>
<li><p>解压neo4j-spatial-0.9-SNAPSHOT-server-plugin.zip，将里面除了gt-*_8.0的jar包 拷进geoserver/WEB-INF/lib 文件夹</p>
</li>
<li><p>复制neo4j/lib 里面所有jar 进入geoserver/WEB-INF/lib 文件夹</p>
</li>
<li><p>重启geoserver 通过访问GeoServer地址<a href="http://localhost:8080/geoserver/web/，我们可以看到如图所示，neo4j可以作为geoserver的后端，提供地图服务" target="_blank" rel="noopener">http://localhost:8080/geoserver/web/，我们可以看到如图所示，neo4j可以作为geoserver的后端，提供地图服务</a></p>
</li>
</ul>
<img src="/2017/01/23/introduction-to-neo4j/2.png">
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="建空间索引内存溢出问题"><a href="#建空间索引内存溢出问题" class="headerlink" title="建空间索引内存溢出问题"></a>建空间索引内存溢出问题</h3><p>neo4j transaction优化方案：每n条手动提交事物</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// 获取所有地址节类型，针对不同地址节分别构建R树索引</span><br><span class="line">public void createAddressNodeIndex_spatial(Set&lt; String&gt; addressNodes) &#123;</span><br><span class="line">    final long commitInterval = 10000;</span><br><span class="line">    Transaction tx = graphDBService.beginTx();</span><br><span class="line">    try &#123;</span><br><span class="line">        long i = 0L;</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        for (String addressNodeLabel : addressNodes) &#123;</span><br><span class="line">            Index&lt; Node&gt; index = getSpatialIndex(UADBLabel.valueOf(addressNodeLabel));</span><br><span class="line">            ResourceIterator&lt; Node&gt; nodes = graphDBService.findNodes(createAddresseNodeLable(addressNodeLabel));</span><br><span class="line">            while (nodes.hasNext()) &#123;</span><br><span class="line">                Node node = nodes.next();</span><br><span class="line">                if (node.getProperty(&quot;lon&quot;, null) != null &amp;&amp; node.getProperty(&quot;lat&quot;, null) != null) &#123;</span><br><span class="line">                    index.add(node, &quot;&quot;, &quot;&quot;);</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                // 处理内存溢出</span><br><span class="line">                if (i % commitInterval == 0) &#123;</span><br><span class="line">                    tx.success();</span><br><span class="line">                    tx.close();</span><br><span class="line">                    log.info(&quot;indexing (&#123;&#125; nodes added) ... time in seconds:&#123;&#125;&quot;, i,</span><br><span class="line">                            DateUtil.convertMillis2DateStr(System.currentTimeMillis() - startTime));</span><br><span class="line">                    tx = graphDBService.beginTx();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tx.success();</span><br></pre></td></tr></table></figure>
<p>建空间索引速度还是偏慢，35万左右的数据量建索引花了将近1.5小时。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://code-monkey.top">Anthon</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://code-monkey.top/2017/01/23/introduction-to-neo4j/">http://code-monkey.top/2017/01/23/introduction-to-neo4j/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/neo4j/">neo4j</a>
            
              <a href="/tags/spatial/">spatial</a>
            
              <a href="/tags/geo/">geo</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/07/08/introduction-to-seaborn/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">introduction to seaborn</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/01/04/matrix-summary-in-linear-algebra/">
        <span class="next-text nav-default">线性代数之各种各样的矩阵</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:tanghuaidong@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/tangboy" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://www.zhihu.com/people/tang-huai-dong/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2020

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Anthon</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

  </body>
</html>
